{% comment %}
  Marquee Carousel Section (DU version)
  - Infinite smooth scrolling with multiple clones
  - Customizable padding, colors, and image sizes
  - Supports up to 12 images
  - Zero blank space during animation
{% endcomment %}

<section
  class="du-marquee-section"
  style="
    --du-marquee-padding-top: {{ section.settings.padding_top }}px;
    --du-marquee-padding-bottom: {{ section.settings.padding_bottom }}px;
    --du-marquee-bg-color: {{ section.settings.bg_color }};
    --du-marquee-gap: {{ section.settings.image_gap }}px;
  "
>
  <div class="du-marquee-container">
    <div class="du-marquee-track" data-speed="{{ section.settings.animation_speed }}">
      {% comment %} Clone images 4 times for seamless infinite loop {% endcomment %}
      {% for clone in (1..4) %}
        {% for block in section.blocks %}
          {% if block.type == 'image' and block.settings.image %}
            <div class="du-marquee-item" data-size="{{ section.settings.image_size }}">
              <img
                height="70"
                width="70"
                src="{{ block.settings.image | image_url: width: 300 }}"
                alt="{{ block.settings.image.alt | default: 'Brand logo' }}"
                loading="lazy"
                class="du-marquee-image"
                style="
                  width: {{ section.settings.image_size }}px;
                  height: auto;
                  object-fit: contain;
                  filter: brightness({{ section.settings.brightness }}%);
                "
              >
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</section>

<style>
  .du-marquee-section {
    padding-top: var(--du-marquee-padding-top);
    padding-bottom: var(--du-marquee-padding-bottom);
    background-color: var(--du-marquee-bg-color);
    overflow: hidden;
    width: 100%;
  }

  .du-marquee-container {
    width: 100%;
    overflow: hidden;
  }

  .du-marquee-track {
    display: flex;
    gap: var(--du-marquee-gap);
    will-change: transform;
    backface-visibility: hidden;
    transform: translateZ(0);
  }

  .du-marquee-item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 var(--du-marquee-gap);
  }

  .du-marquee-image {
    max-width: 100%;
    height: auto;
    display: block;
  }

  @keyframes du-marquee-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(var(--du-marquee-translate-distance));
    }
  }

  .du-marquee-track.du-animating {
    animation: du-marquee-scroll var(--du-marquee-duration) linear infinite;
  }

  {% if section.settings.pause_on_hover %}
    .du-marquee-track.du-animating:hover {
      animation-play-state: paused;
    }
  {% endif %}

  /* Responsive design */
  @media (max-width: 768px) {
    .du-marquee-section {
      padding-top: calc(var(--du-marquee-padding-top) * 0.75);
      padding-bottom: calc(var(--du-marquee-padding-bottom) * 0.75);
    }

    .du-marquee-item {
      padding: 0 calc(var(--du-marquee-gap) * 0.75);
    }

    .du-marquee-image {
      width: calc(var(--du-marquee-image-size) * 0.75) !important;
    }
  }

  @media (max-width: 480px) {
    .du-marquee-section {
      padding-top: calc(var(--du-marquee-padding-top) * 0.5);
      padding-bottom: calc(var(--du-marquee-padding-bottom) * 0.5);
    }

    .du-marquee-item {
      padding: 0 calc(var(--du-marquee-gap) * 0.5);
    }

    .du-marquee-image {
      width: calc(var(--du-marquee-image-size) * 0.5) !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const duTrack = document.querySelector('.du-marquee-track');
    const duItems = document.querySelectorAll('.du-marquee-item');

    if (duTrack && duItems.length > 0) {
      function duInitializeMarquee() {
        const itemWidth = duItems[0].offsetWidth;
        const gap = parseFloat(getComputedStyle(duTrack).gap) || 0;
        const itemsPerSet = duItems.length / 4;
        const oneSetWidth = itemWidth * itemsPerSet + gap * (itemsPerSet - 1);

        const speed = parseFloat(duTrack.dataset.speed) || 30;
        duTrack.style.setProperty('--du-marquee-translate-distance', `-${oneSetWidth}px`);
        duTrack.style.setProperty('--du-marquee-duration', `${speed}s`);
        duTrack.classList.add('du-animating');
      }

      const duImages = duTrack.querySelectorAll('img');
      let loaded = 0;

      if (duImages.length === 0) {
        duInitializeMarquee();
      } else {
        duImages.forEach((img) => {
          if (img.complete) {
            loaded++;
          } else {
            img.addEventListener('load', () => {
              loaded++;
              if (loaded === duImages.length) duInitializeMarquee();
            });
          }
        });

        if (loaded === duImages.length) duInitializeMarquee();
      }

      let duResizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(duResizeTimer);
        duResizeTimer = setTimeout(duInitializeMarquee, 250);
      });
    }
  });
</script>

{% schema %}
{
  "name": "Marquee Carousel",
  "settings": [
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Top Padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 40
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "image_size",
      "label": "Logo Size",
      "options": [
        { "value": "70", "label": "Small" },
        { "value": "120", "label": "Medium" },
        { "value": "180", "label": "Large" }
      ],
      "default": "120"
    },
    {
      "type": "range",
      "id": "animation_speed",
      "min": 10,
      "max": 60,
      "step": 5,
      "unit": "s",
      "label": "Animation Speed",
      "default": 30
    },
    {
      "type": "range",
      "id": "image_gap",
      "min": 10,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Gap Between Logos",
      "default": 40
    },
    {
      "type": "range",
      "id": "brightness",
      "min": 50,
      "max": 150,
      "step": 10,
      "unit": "%",
      "label": "Brightness",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause Animation on Hover",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Logo",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Marquee Carousel",
      "category": "Custom",
      "blocks": [{ "type": "image" }, { "type": "image" }, { "type": "image" }]
    }
  ]
}
{% endschema %}
